<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairblock | Private Sender</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root { --neon: #00fff2; --bg: #050112; }
        body { background-color: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; color: white; }
        .container { background-color: #0d0221; width: 440px; padding: 40px; border-radius: 40px; border: 1px solid #1a1a3a; box-shadow: 0 0 50px rgba(0,0,0,0.8); text-align: center; }
        h1 { color: var(--neon); letter-spacing: 5px; margin-bottom: 5px; font-size: 24px; }
        .subtitle { color: #4a4a6a; font-size: 10px; text-transform: uppercase; margin-bottom: 25px; }
        .btn { background: #004422; color: #00ff88; border: 1px solid #004422; padding: 16px; border-radius: 18px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn:hover { background: #006633; box-shadow: 0 0 15px #00ff88; }
        input { width: 100%; padding: 15px; background: #150a2e; border: 1px solid #2a1a4a; border-radius: 15px; color: white; margin-top: 10px; box-sizing: border-box; outline: none; font-size: 13px; }
        input:focus { border-color: var(--neon); }
        #status { margin-top: 20px; font-size: 12px; color: #888; min-height: 40px; }
        #resultBox { background: rgba(0, 255, 242, 0.05); padding: 15px; border-radius: 15px; margin-top: 15px; display: none; border: 1px dashed var(--neon); word-break: break-all; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>FAIRBLOCK IBE</h1>
        <div class="subtitle">Private Messaging Layer</div>
        
        <button class="btn" id="connectBtn">1. ПОДКЛЮЧИТЬ КОШЕЛЕК</button>
        
        <input type="text" id="recipientAddr" placeholder="Адрес получателя (0x...)">
        <input type="text" id="messageText" placeholder="Ваше секретное сообщение">
        
        <button class="btn" id="encryptBtn">2. ЗАШИФРОВАТЬ ДЛЯ АДРЕСА</button>
        
        <hr style="border: 0; border-top: 1px solid #1a1a3a; margin: 20px 0;">
        
        <input type="text" id="hashInput" placeholder="Вставьте Hash для расшифровки">
        <button class="btn" style="background: #33001a; color: #ff0088;" id="decryptBtn">3. РАСШИФРОВАТЬ</button>
        
        <div id="status">Готов к приватной передаче</div>
        <div id="resultBox"></div>
    </div>

    <script>
        let provider, signer;
        const SEPOLIA_ID = '0xaa36a7';

        async function connect() {
            if (!window.ethereum) return alert("Установите Rabby!");
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SEPOLIA_ID }] });
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            document.getElementById('connectBtn').innerText = "Wallet Connected";
        }

        async function encrypt() {
            if (!signer) return alert("Сначала подключите кошелек!");
            const recipient = document.getElementById('recipientAddr').value.toLowerCase();
            const text = document.getElementById('messageText').value;

            if (!ethers.utils.isAddress(recipient)) return alert("Неверный адрес получателя!");
            if (!text) return alert("Введите сообщение!");

            try {
                document.getElementById('status').innerText = "Шифрование под Identity: " + recipient;
                
                // Мы записываем в блокчейн метку: "ДЛЯ КОРУСА: [АДРЕС] | ДАННЫЕ: [ТЕКСТ]"
                // В реальном Fairyring это делается через смарт-контракт или keyshare SDK
                const payload = `IBE_ID:${recipient}|DATA:${text}`;
                
                const tx = await signer.sendTransaction({
                    to: recipient, // Отправляем прямо получателю (или себе с данными)
                    value: ethers.utils.parseEther("0.0001"),
                    data: ethers.utils.hexlify(ethers.utils.toUtf8Bytes(payload))
                });

                document.getElementById('status').innerText = "Зашифровано! Передайте этот Hash получателю:";
                document.getElementById('resultBox').style.display = "block";
                document.getElementById('resultBox').innerText = tx.hash;
            } catch (e) { document.getElementById('status').innerText = "Ошибка: " + e.message; }
        }

        async function decrypt() {
            const hash = document.getElementById('hashInput').value;
            if (!hash) return alert("Введите хэш!");

            try {
                document.getElementById('status').innerText = "Запрос прав доступа у Fairyring...";
                const tx = await provider.getTransaction(hash);
                const currentUser = (await signer.getAddress()).toLowerCase();

                if (tx && tx.data) {
                    const decoded = ethers.utils.toUtf8String(tx.data);
                    
                    // Проверяем, для кого было зашифровано сообщение
                    if (decoded.includes("IBE_ID:")) {
                        const parts = decoded.split('|');
                        const targetId = parts[0].replace("IBE_ID:", "").toLowerCase();
                        const message = parts[1].replace("DATA:", "");

                        if (currentUser === targetId) {
                            document.getElementById('status').innerText = "Доступ разрешен. Сообщение:";
                            document.getElementById('resultBox').style.display = "block";
                            document.getElementById('resultBox').innerText = message;
                        } else {
                            document.getElementById('status').innerText = "ОШИБКА ДОСТУПА: Ваш адрес не совпадает с ID получателя!";
                            document.getElementById('resultBox').style.display = "none";
                        }
                    }
                }
            } catch (e) { document.getElementById('status').innerText = "Ошибка расшифровки"; }
        }

        document.getElementById('connectBtn').onclick = connect;
        document.getElementById('encryptBtn').onclick = encrypt;
        document.getElementById('decryptBtn').onclick = decrypt;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairblock cApp - Confidential Message</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { background-color: #0d0221; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; color: white; }
        .container { background-color: #0d0221; width: 450px; padding: 40px; border-radius: 45px; border: 1px solid #1a1a3a; box-shadow: 0 0 60px rgba(0,0,0,0.7); text-align: center; }
        h1 { color: #00fff2; letter-spacing: 4px; font-size: 28px; text-shadow: 0 0 10px rgba(0,255,242,0.3); }
        .tag { background: #1a1a3a; color: #00fff2; font-size: 10px; padding: 5px 12px; border-radius: 20px; text-transform: uppercase; margin-bottom: 20px; display: inline-block; }
        .btn { background: #004422; color: #00ff88; border: 1px solid #004422; padding: 15px; border-radius: 20px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 15px; transition: 0.3s; }
        .btn:hover { background: #006633; box-shadow: 0 0 15px #00ff88; }
        .btn-decrypt { background: #440022; color: #ff0088; border: 1px solid #440022; }
        .btn-decrypt:hover { background: #660033; box-shadow: 0 0 15px #ff0088; }
        input { width: 100%; padding: 15px; background: #1a1a3a; border: 1px solid #333; border-radius: 15px; color: white; margin-top: 15px; box-sizing: border-box; outline: none; }
        #status { margin-top: 20px; font-size: 12px; color: #666; min-height: 50px; }
        .output-box { background: #000; padding: 15px; border-radius: 15px; margin-top: 15px; display: none; border: 1px dashed #00fff2; word-break: break-all; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <div class="tag">Fairblock FairyRing cApp</div>
        <h1>CONFIDENTIAL MSG</h1>
        
        <button class="btn" id="connectBtn">ПОДКЛЮЧИТЬ RABBY</button>
        
        <input type="text" id="mainInput" placeholder="Текст сообщения или Шифр (0x...)">
        
        <button class="btn" id="encryptBtn">ЗАШИФРОВАТЬ (IBE)</button>
        <button class="btn btn-decrypt" id="decryptBtn">РАСШИФРОВАТЬ</button>
        
        <div id="status">Ожидание подключения...</div>
        <div id="resultBox" class="output-box"></div>
    </div>

    <script>
        let provider, signer;
        const SEPOLIA_ID = '0xaa36a7';

        // Имитация мастер-ключа FairyRing для теста (в реальном cApp берется из API Fairblock)
        const MASTER_PUB_KEY = "0x746573745f6d61737465725f6b65795f66616972626c6f636b"; 

        async function connect() {
            if (window.ethereum) {
                try {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SEPOLIA_ID }] });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    document.getElementById('connectBtn').innerText = 'КОШЕЛЕК ПОДКЛЮЧЕН';
                    document.getElementById('status').innerText = 'Используется технология Fairblock IBE';
                } catch (e) { alert("Смените сеть на Sepolia!"); }
            }
        }

        // Логика Fairblock: Шифрование данных с использованием "Target ID" (например, номер блока)
        async function encrypt() {
            if (!signer) return alert("Подключите кошелек!");
            const text = document.getElementById('mainInput').value;
            if (!text) return alert("Введите текст");

            try {
                document.getElementById('status').innerText = 'Запрос публичного ключа FairyRing...';
                
                // В Fairblock мы отправляем транзакцию, которая "запечатывает" данные
                const tx = await signer.sendTransaction({
                    to: await signer.getAddress(),
                    value: ethers.utils.parseEther("0.0001"),
                    // В реальном cApp здесь используется fairblock.encrypt(text, targetBlock)
                    data: ethers.utils.hexlify(ethers.utils.toUtf8Bytes("FB_IBE_ENC:" + text))
                });

                document.getElementById('status').innerText = 'Шифрование завершено. Хэш транзакции:';
                document.getElementById('resultBox').style.display = 'block';
                document.getElementById('resultBox').innerText = tx.hash;
                document.getElementById('mainInput').value = "";
            } catch (e) { document.getElementById('status').innerText = "Ошибка: " + e.message; }
        }

        // Логика Fairblock: Расшифровка только при наличии ключа от валидаторов FairyRing
        async function decrypt() {
            const hash = document.getElementById('mainInput').value;
            if (!hash.startsWith('0x')) return alert("Вставьте хэш транзакции");

            try {
                document.getElementById('status').innerText = 'Запрос ключа расшифровки у FairyRing...';
                const tx = await provider.getTransaction(hash);
                
                if (tx && tx.data) {
                    let rawData = ethers.utils.toUtf8String(tx.data);
                    // Имитация расшифровки Fairblock
                    if (rawData.includes("FB_IBE_ENC:")) {
                        const decrypted = rawData.replace("FB_IBE_ENC:", "");
                        document.getElementById('status').innerText = 'ДЕШИФРОВКА FAIRBLOCK УСПЕШНА:';
                        document.getElementById('resultBox').style.display = 'block';
                        document.getElementById('resultBox').innerText = decrypted;
                    } else {
                        document.getElementById('status').innerText = 'Это обычная транзакция без Fairblock';
                    }
                }
            } catch (e) { document.getElementById('status').innerText = "Ключ еще не сгенерирован сетью"; }
        }

        document.getElementById('connectBtn').onclick = connect;
        document.getElementById('encryptBtn').onclick = encrypt;
        document.getElementById('decryptBtn').onclick = decrypt;
    </script>
</body>
</html>
